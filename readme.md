# koishi-plugin-chat-analyse

[![npm](https://img.shields.io/npm/v/koishi-plugin-chat-analyse?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-chat-analyse)

强大而全面的聊天数据分析，支持统计命令，发言，消息类型，活跃度，支持发言排行和生成词云

## ✨ 功能特性

- **高效数据收集**：采用异步、高并发和缓存机制，在不影响机器人性能的前提下，精确高效地收集聊天数据。
- **多维度统计分析**：
  - **命令统计** (`cmdstat`)：追踪指令使用频率，了解用户最常用的功能。
  - **发言统计** (`msgstat`)：分析用户发言类型与数量，掌握核心用户群体。
  - **发言排行** (`rankstat`)：生成指定时间范围内的用户发言排行榜。
  - **活跃度分析** (`activity`)：以小时或天为单位，生成直观的周期性活跃度图表。
- **高级文本分析**：
  - **词云生成** (`wordcloud`)：基于聊天记录，利用 Jieba 分词生成热门话题词云图。
  - **提及追踪** (`whoatme`)：轻松查询谁在什么时候因为什么内容提及了您。
- **强大的数据管理**：
  - **备份与恢复** (`backup`/`restore`)：一键备份所有统计数据至本地，并可随时恢复，保障数据安全。
  - **精确清理** (`clear`)：提供多维度的筛选条件（如按时间、用户、群组、命令），精确清理不再需要的数据。
- **精美图表渲染**：借助 Puppeteer 服务，将复杂的统计数据渲染成美观、易读的图片，方便在聊天中分享。
- **高度可配置**：所有功能模块均可独立开关，并可自定义数据保留时长等核心参数，以适应不同场景的需求。

### 前置服务

本插件依赖以下 Koishi 服务，请确保您已正确安装并启用了它们：

- `database`：用于存储所有统计分析数据。
- `puppeteer`：用于将统计结果渲染成图片。
- `cron`：用于执行数据定时清理任务。

## 📝 使用说明

所有功能都集成在主指令 `analyse` 之下。

### 指令列表

| 指令 | 别名 | 描述 | 选项 |
| --- | --- | --- | --- |
| `analyse.cmdstat` | 命令统计 | 查询命令使用情况，展示方式根据选项变化 | `-u <user>`, `-g <guild>`, `-a` (全局), `-s` (分离子指令) |
| `analyse.msgstat` | 发言统计 | 查询用户发言统计，展示方式根据选项变化 | `-u <user>`, `-g <guild>`, `-a` (全局), `-t <type>` (指定消息类型) |
| `analyse.rankstat` | 发言排行 | 查询指定时间内的发言排行，展示方式根据选项变化 | `-u <user>`, `-g <guild>`, `-a` (全局), `-t <type>`, `-n <hours>`, `-o <hours>` |
| `analyse.activity` | 活跃统计 | 查询周期性活跃度图表 | `-u <user>`, `-g <guild>`, `-a` (全局), `-d` (按天), `-n <units>`, `-o <units>` |
| `analyse.wordcloud` | 生成词云 | 基于聊天记录生成词云图 | `-u <user>`, `-g <guild>`, `-t <hours>` (默认24小时) |
| `analyse.whoatme` | 谁提及我 | 查看最近谁提及了您 | (无) |
| `analyse.list` | 列出数据 | 列出已记录的频道和命令 | (无) |
| `analyse.backup` | 备份数据 | 将所有数据备份为本地 JSON 文件 | (无) |
| `analyse.restore` | 恢复数据 | 从本地 JSON 文件恢复数据 | (无) |
| `analyse.clear` | 清除数据 | 根据条件精确清理数据 | `-t <table>`, `-g <guild>`, `-u <user>`, `-d <days>`, `-c <command>`, `-a` (全部) |

### 🔎 指令详解

#### `analyse.cmdstat` (命令统计)

- **`analyse cmdstat`**: 查询**当前群组**所有用户的命令统计。
- **`analyse cmdstat -u @用户`**: 查询**指定用户**在**所有群组**的命令统计。
- **`analyse cmdstat -g <群组ID>`**: 查询**指定群组**所有用户的命令统计。
- **`analyse cmdstat -u @用户 -g <群组ID>`**: 查询**指定用户**在**指定群组**的命令统计。
- **`analyse cmdstat -a`**: 查询**全局**（所有用户+所有群组）的命令统计。
- **选项 `-s`**: 分离展示子命令，不合并到主命令。

#### `analyse.msgstat` (发言统计)

- **`analyse msgstat`**: 查询**当前群组**的发言统计 (按**用户**展示)。
- **`analyse msgstat -u @用户`**: 查询**指定用户**的发言统计 (按**群组**展示)。
- **`analyse msgstat -g <群组ID>`**: 查询**指定群组**的发言统计 (按**用户**展示)。
- **`analyse msgstat -u @用户 -g <群组ID>`**: 查询**指定用户**在**指定群组**的发言统计 (按**消息类型**展示)。
- **`analyse msgstat -a`**: 查询**全局**发言统计 (按**用户**展示)。
- **选项 `-t <类型>`**: 筛选指定消息类型，不改变上述展示逻辑。

#### `analyse.rankstat` (发言排行)

- **`analyse rankstat`**: 查询**当前群组**的发言排行 (按**用户**排名)。
- **`analyse rankstat -u @用户`**: 查询**指定用户**的发言排行 (按**群组**排名)。
- **`analyse rankstat -g <群组ID>`**: 查询**指定群组**的发言排行 (按**用户**排名)。
- **`analyse rankstat -u @用户 -g <群组ID>`**: 查询**指定用户**在**指定群组**的发言排行 (按**消息类型**排名)。
- **`analyse rankstat -a`**: 查询**全局**发言排行 (按**用户**排名)。
- **选项 `-n <小时数>`**: 指定查询范围的时长，默认为 `24`。
- **选项 `-o <小时数>`**: 指定查询结束时间的偏移量（从现在往前推的小时数），默认为 `0`。
- **选项 `-t <类型>`**: 筛选指定消息类型，不改变上述展示逻辑。

#### `analyse.activity` (活跃统计)

- **`analyse activity`**: 查询**当前群组**的活跃度。
- **`analyse activity -u @用户`**: 查询**指定用户**在**所有群组**的活跃度。
- **`analyse activity -g <群组ID>`**: 查询**指定群组**的活跃度。
- **`analyse activity -u @用户 -g <群组ID>`**: 查询**指定用户**在**指定群组**的活跃度。
- **`analyse activity -a`**: 查询**全局**活跃度。
- **选项 `-n <数值>`**: 指定查询范围的时长，默认为 `24`。
- **选项 `-o <数值>`**: 指定查询结束时间的偏移量，默认为 `0`。
- **选项 `-d`**: 将 `-n` 和 `-o` 的单位从**小时**切换为**天**。

### 配置项

您可以在插件的配置页面中调整以下选项：

#### 杂项配置

- `enableListener`: **启用消息监听**。总开关，关闭后插件将停止所有数据收集。 (默认: `true`)
- `enableDataIO`: **启用数据管理**。控制 `.backup`, `.restore`, `.clear`, `.list` 等指令的可用性。 (默认: `true`)

#### 基础分析配置

- `enableCmdStat`: **启用命令统计**。 (默认: `true`)
- `enableMsgStat`: **启用消息统计**。 (默认: `true`)
- `enableActivity`: **启用活跃统计**。 (默认: `true`)
- `enableRankStat`: **启用发言排行**。 (默认: `true`)
- `rankRetentionDays`: **排行保留天数**。发言排行数据的保留时长（天），`0` 为永久保留。 (默认: `180`)
- `enableWhoAt`: **启用提及记录**。 (默认: `true`)
- `atRetentionDays`: **提及保留天数**。`whoatme` 数据的保留时长（天），`0` 为永久保留。 (默认: `3`)

#### 高级分析配置

- `enableOriRecord`: **启用原始记录**。是否记录原始消息内容以供词云等功能使用。 (默认: `true`)
- `enableWordCloud`: **启用词云生成**。 (默认: `true`)
- `cacheRetentionDays`: **原始记录保留天数**。原始消息记录的保留时长（天），`0` 为永久保留。 (默认: `30`)
